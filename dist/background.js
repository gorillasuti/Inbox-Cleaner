import{s as n}from"./chunks/supabase-CImf-YWG.js";import"./chunks/supabase-BCehgc4o.js";import"./chunks/lottie-CRt1SRO1.js";chrome.runtime.onMessage.addListener((o,g,e)=>{if(o.action==="SUPABASE_LOGIN")return n.auth.signInWithPassword({email:o.email,password:o.password}).then(({data:r,error:t})=>{e(t?{error:t.message}:{data:r})}),!0;if(o.action==="SUPABASE_SIGNUP")return n.auth.signUp({email:o.email,password:o.password,options:{data:{full_name:o.fullName}}}).then(({data:r,error:t})=>{e(t?{error:t.message}:{data:r})}),!0;if(o.action==="SUPABASE_LOGOUT")return n.auth.signOut().then(({error:r})=>{e(r?{error:r.message}:{success:!0})}),!0;if(o.action==="SUPABASE_GET_SESSION")return n.auth.getSession().then(({data:r,error:t})=>{e(t?{error:t.message}:{session:r.session})}),!0;if(o.action==="SUPABASE_OAUTH_GOOGLE"){const r=chrome.identity.getRedirectURL();return console.log("[Background] Generated Redirect URL:",r),n.auth.signInWithOAuth({provider:"google",options:{scopes:"https://www.googleapis.com/auth/gmail.modify",redirectTo:r}}).then(({data:t,error:c})=>{c?(console.error("[Background] Supabase OAuth Init Error:",c),e({error:c.message})):(console.log("[Background] Supabase OAuth Init Success. Auth URL:",t.url),t.url?chrome.identity.launchWebAuthFlow({url:t.url,interactive:!0},async i=>{if(chrome.runtime.lastError){console.error("[Background] LaunchWebAuthFlow Error:",chrome.runtime.lastError.message),e({error:chrome.runtime.lastError.message});return}console.log("[Background] WebAuthFlow Success. Response URL:",i),e({data:{redirectUrl:i}})}):(console.error("[Background] No Auth URL returned from Supabase"),e({error:"No Auth URL returned"})))}),!0}if(o.action==="SUPABASE_SET_SESSION")return n.auth.setSession({access_token:o.access_token,refresh_token:o.refresh_token}).then(({data:r,error:t})=>{var c;t?(console.error("[Background] Set Session Error:",t),e({error:t.message})):(console.log("[Background] Session set successfully for:",(c=r.user)==null?void 0:c.email),e({data:r}))}),!0;if(o.action==="CREATE_CHECKOUT_SESSION")return console.log("[Background] Creating checkout session...",o),fetch(`${o.apiUrl}/api/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.accessToken}`},body:JSON.stringify({priceId:o.priceId,extensionId:chrome.runtime.id})}).then(r=>r.json()).then(r=>{r.error?(console.error("[Background] Checkout API Error:",r.error),e({error:r.error})):(console.log("[Background] Checkout Session Created:",r.url),e({data:r}))}).catch(r=>{console.error("[Background] Checkout Fetch Error:",r),e({error:r.message})}),!0;if(o.action==="CREATE_PORTAL_SESSION")return console.log("[Background] Creating portal session...",o),fetch(`${o.apiUrl}/api/create-portal-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.accessToken}`},body:JSON.stringify({returnUrl:o.returnUrl})}).then(r=>r.json()).then(r=>{r.error?(console.error("[Background] Portal API Error:",r.error),e({error:r.error})):(console.log("[Background] Portal Session Created:",r.url),e({data:r}))}).catch(r=>{console.error("[Background] Portal Fetch Error:",r),e({error:r.message})}),!0;if(o.action==="CANCEL_SUBSCRIPTION")return console.log("[Background] Cancelling subscription...",o),fetch(`${o.apiUrl}/api/cancel-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.accessToken}`}}).then(r=>r.json()).then(r=>{r.error?(console.error("[Background] Cancel API Error:",r.error),e({error:r.error})):(console.log("[Background] Subscription Canceled:",r),e({data:r}))}).catch(r=>{console.error("[Background] Cancel Fetch Error:",r),e({error:r.message})}),!0;if(o.action==="RESUME_SUBSCRIPTION")return console.log("[Background] Resuming subscription...",o),fetch(`${o.apiUrl}/api/resume-subscription`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.accessToken}`}}).then(r=>r.json()).then(r=>{r.error?(console.error("[Background] Resume API Error:",r.error),e({error:r.error})):(console.log("[Background] Subscription Resumed:",r),e({data:r}))}).catch(r=>{console.error("[Background] Resume Fetch Error:",r),e({error:r.message})}),!0;if(o.action==="UNSUBSCRIBE_VIA_POST")return console.log("[Background] Executing POST unsubscribe to:",o.url),fetch(o.url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","List-Unsubscribe":`<${o.url}>`},body:o.body}).then(r=>{r.ok?e({success:!0}):e({error:`Status: ${r.status}`})}).catch(r=>e({error:r.message})),!0;if(o.action==="UNSUBSCRIBE_VIA_GET")return console.log("[Background] Executing GET unsubscribe to:",o.url),fetch(o.url,{method:"GET"}).then(r=>{e({success:!0})}).catch(r=>e({error:r.message})),!0;if(o.action==="OAUTH_REQUEST"){console.log(`[Background] OAuth request for ${o.provider}`);const t={gmail:{clientId:"119111271548-qganbion1n21jtuon51a0t7e9g6jvu4c.apps.googleusercontent.com",scopes:["https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/gmail.modify"],authUrl:"https://accounts.google.com/o/oauth2/v2/auth"},outlook:{clientId:"YOUR_OUTLOOK_CLIENT_ID",scopes:["https://graph.microsoft.com/Mail.Read","https://graph.microsoft.com/Mail.ReadWrite"],authUrl:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize"}}[o.provider];if(!t)return e({error:`Unknown provider: ${o.provider}`}),!0;const c=chrome.identity.getRedirectURL(),i=new URLSearchParams({client_id:t.clientId,response_type:"token",redirect_uri:c,scope:t.scopes.join(" ")}),h=`${t.authUrl}?${i.toString()}`;return chrome.identity.launchWebAuthFlow({url:h,interactive:o.interactive!==void 0?o.interactive:!0},s=>{if(chrome.runtime.lastError){console.error("[Background] OAuth failed:",chrome.runtime.lastError.message),e({error:chrome.runtime.lastError.message});return}if(!s){e({error:"OAuth window closed or no response URL"});return}const l=new URLSearchParams(s.split("#")[1]||""),a={access_token:l.get("access_token"),refresh_token:l.get("refresh_token"),expires_in:parseInt(l.get("expires_in")||"3600")};if(!a.access_token){e({error:"No access token returned"});return}const m=Date.now()+a.expires_in*1e3,u={access_token:a.access_token,refresh_token:a.refresh_token,expires_at:m,provider:o.provider};chrome.storage.local.set({[`${o.provider}_token`]:u},()=>{console.log(`[Background] Token stored for ${o.provider}`),e({success:!0,token:u})})}),!0}});chrome.action.onClicked.addListener(o=>{console.log("[Inbox Cleaner] Action clicked on tab:",o.id,o.url),o.url.includes("mail.google.com")||o.url.includes("outlook.live.com")||o.url.includes("mail.yahoo.com")?(console.log("[Inbox Cleaner] Sending toggle_sidebar message..."),chrome.tabs.sendMessage(o.id,{action:"toggle_sidebar"},g=>{chrome.runtime.lastError?console.error("[Inbox Cleaner] Error sending message:",chrome.runtime.lastError.message):console.log("[Inbox Cleaner] Message sent successfully.")})):console.log("[Inbox Cleaner] URL not supported for toggle.")});
